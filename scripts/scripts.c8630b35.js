"use strict";function filterConvert(a,b){if(b){for(var c in a)a[c].filter&&b&&b[c]&&(a[c].filter.term=b[c]),a[c].filters&&b&&(b[c]||0==b[c])&&(a[c].filters[0].term=b[c]);return a}var b={};for(var c in a)a[c].filter&&a[c].filter.term&&(b[c]=a[c].filter.term),a[c].filters&&(a[c].filters[0].term||0==a[c].filters[0].term)&&(b[c]=a[c].filters[0].term);return b}angular.module("superstockApp",["ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","ui.grid","agGrid","ui.grid.pinning","firebase.auth","firebase.ref","ui.slider","btorfs.multiselect","uiSwitch"]).config(["$locationProvider",function(a){a.hashPrefix("")}]),$(document).on("click",".ag-row",function(){var a=$(this),b=a.prop("class").indexOf("click-row");$(".ag-row").removeClass("click-row"),b>-1?a.removeClass("click-row"):a.addClass("click-row")}),angular.module("superstockApp").factory("dataProvider",["$firebaseArray",function(a){function b(a,b,c){var d={};a.idLabel&&(d[a.idLabel]=b);var e=c.split("|");for(var f in a.labelList)a.labelList[f].format.indexOf("percent")>-1?(""==e[f]?d[a.labelList[f].fieldName]="":d[a.labelList[f].fieldName]=Math.ceil(1e4*e[f])/100,isNaN(d[a.labelList[f].fieldName])&&(d[a.labelList[f].fieldName]="")):a.labelList[f].format.indexOf("bigNum")>-1||a.labelList[f].format.indexOf("number")>-1?(d[a.labelList[f].fieldName]=parseFloat(e[f]),isNaN(d[a.labelList[f].fieldName])&&(d[a.labelList[f].fieldName]="")):d[a.labelList[f].fieldName]=e[f];return d}function c(a){var b="Bản thu phí";return a.signal1=b,a.signal2=b,a.symbol2=b,a.Canslim=b,a.power=b,a.volumeChange=b,a}var d=function(d,e,f,g,h,i){var j=a(e);g(),j.$loaded(function(){var a=j.map(function(a){var e=b(f,a.$id,a.$value);return d||(e=c(e)),e});h(a)}).then(function(){e.on("child_added",function(a,e){var g=b(f,a.key,a.val());d||(g=c(g)),i.added(g,a,e)}),e.on("child_changed",function(a,e){var g=b(f,a.key,a.val());d||(g=c(g)),i.changed(g,a,e)}),e.on("child_removed",function(a){i.removed(a)})}).then(function(){j.$watch(function(a){})})};return{load:d}}]),angular.module("superstockApp").factory("utils",["$http","$q","$rootScope","$timeout","$firebaseObject","Ref",function(a,b,c,d,e,f){const g="https://price-sync-227313.firebaseio.com";var h;return{debounce:function(a,b){void 0!=h&&d.cancel(h),h=d(function(){a(),h=void 0},b)},getCellClass:function(a,b,c){var d=a.colDef.field,e=a.value,f=[];switch(c&&""!=c&&"symbol"!=d&&f.push("ag-cell-focus-bg"),(b[d].indexOf("number")>-1||b[d].indexOf("percent")>-1||b[d].indexOf("bigNum")>-1)&&f.push("ui-cell-align-right"),a.value&&b[d].indexOf("percent")>-1&&f.push("percent"),d){case"priceChange":0>e?f.push("grid-cell-red"):f.push("grid-cell-green");break;case"EPS":1e3>e?f.push("grid-cell-red"):f.push("grid-cell-green");break;case"revenueChange":case"EPSChange":case"profitChange":0>e?f.push("grid-cell-red"):f.push("grid-cell-green");break;case"point":5>e?f.push("grid-cell-red"):e>=5&&7>e?f.push("grid-cell-green"):f.push("grid-cell-purple");break;case"roe":10>e&&f.push("grid-cell-red"),e>20?f.push("grid-cell-purple"):f.push("grid-cell-green");break;case"fxEffect":case"cashFlow":0>e?f.push("grid-cell-red"):e>0&&f.push("grid-cell-green")}return f},getCellClassSummary:function(a,b,d){function e(a){return a.EPS>=3e3&&a.roe>=20}var f=a.colDef.field,g=a.value,h=a.data,i=[];switch(d&&""!=d&&"symbol"!=f&&i.push("ag-cell-focus-bg"),b.isNumber&&i.push("ui-cell-align-right"),a.value&&b.isType&&b.isType("percent")&&i.push("percent"),f){case"roe":10>g&&i.push("grid-cell-red"),g>20?(i.push("grid-cell-purple"),i.push("ag-cell-fill-bg")):i.push("grid-cell-green");break;case"symbol":""!=g&&(""!=a.data.signal1||""!=a.data.signal2)&&(i.push("grid-cell-green"),i.push("ag-cell-fill-bg"));break;case"industry":g>=5e9&&"main"==c.link&&(i.push("ag-cell-purple-color"),i.push("ag-cell-fill-bg"));break;case"totalValue":g>=2e10&&(i.push("ag-cell-purple-color"),i.push("ag-cell-fill-bg"));break;case"EPS":g>=3e3?(i.push("ag-cell-purple-color"),i.push("ag-cell-fill-bg")):g>1e3?i.push("grid-cell-green"):1e3>g&&i.push("grid-cell-red");break;case"oldPoint":g>=30&&(i.push("ag-cell-fill-bg"),i.push("ag-cell-purple-color"));break;case"newPoint":g>=7?(i.push("ag-cell-purple-color"),i.push("ag-cell-fill-bg")):g>5?i.push("grid-cell-green"):5==g?i.push("grid-cell-black"):4>=g&&i.push("grid-cell-red"),i.push("text-center");break;case"power":g>=8?(i.push("ag-cell-purple-color"),i.push("ag-cell-fill-bg")):g>=7?i.push("grid-cell-green"):i.push("grid-cell-black"),i.push("text-center");break;case"Canslim":""!=g&&(i.push("ag-cell-fill-bg"),"..Rủi ro"==g?i.push("grid-cell-red"):i.push("ag-cell-purple-color")),i.push("text-center");break;case"symbol2":""!=g&&(""!=a.data.signal1||""!=a.data.signal2)&&(i.push("grid-cell-green"),i.push("ag-cell-fill-bg")),i.push("text-center");break;case"signal1":case"signal2":""!=g&&(e(a.data)&&i.push("ag-cell-purple-color"),i.push("grid-cell-green"),"Điểm chú ý"==g?i.push("ag-cell-fill-bg-yellow"):i.push("ag-cell-fill-bg")),i.push("text-center");break;case"sellSignal":i.push("ag-cell-red-bg"),i.push("text-center");break;case"volumeChange":g>=30&&(i.push("ag-cell-purple-color"),i.push("ag-cell-fill-bg"));break;case"pnl":case"pnlValue":case"pnlPercent":g>0?i.push("grid-cell-green"):i.push("grid-cell-red");break;case"cutLoss":case"two_down":case"min_T10":case"take_profit":g>=h.close&&i.push("ag-cell-red-bg");break;case"priceChange":g>=2&&4>=g&&i.push("ag-cell-fill-bg")}return i},getMarketSummary:function(){var c=b.defer();return a.get("https://price-sync-227313.firebaseio.com/market_summary.json",{}).then(function(a){if(a&&a.data){var b=a.data,d={color:b.color,content:a.data.data?a.data.data.content:"",timestamp:a.data};d.content=d.content.replace("\n","<br />");var e=/(HTTP:\/\/.*)\b/,f=d.content.match(e);f&&2==f.length&&(f=f[0].trim(),d.content=d.content.replace(e,'<a target="_blank" href="'+f+'">LINK</a>')),c.resolve(d)}},function(a){c.reject(a)}),c.promise},getTradingDate:function(){var c=b.defer();return a.get(g+"/trading_date/data.json",{}).then(function(a){a&&a.data&&c.resolve(a.data)},function(a){c.reject(a)}),c.promise},watchSellSymbols:function(a){var b=e(f.child("sell_symbols"));b.$watch(function(){a(b.data.split("|"))})},getCompanyInformation:function(c){var d=b.defer(),e=[];return a.get("https://price-sync-227313.firebaseio.com/profile/"+c+".json",{}).then(function(a){if(a&&a.data&&a.data.data){if(a&&a.data&&a.data.data){var b=a.data.data;e=b}d.resolve(e)}},function(a){d.reject(a)}),d.promise},writeData2Worksheet:function(a,b){return new Promise(function(a,b){var c="data/template.xlsx",d=new XMLHttpRequest;d.open("GET",c,!0),d.responseType="arraybuffer",d.onload=function(b){for(var c=d.response,e=new Uint8Array(c),f=new Array,g=0;g!=e.length;++g)f[g]=String.fromCharCode(e[g]);var h=f.join(""),i=XLSX.read(h,{type:"binary",cellStyles:!0});a(i)},d.send()}).then(function(c){return new Promise(function(d,e){var f=c.Sheets[c.SheetNames[0]],g=4;for(var h in a){var i=0;for(var j in a[h]){var k=j;if("symbol2"==j&&(k+=i,i++),b[k]){var l=b[k].cell;if(l){var m=l+(g+parseInt(h)),n=f[m];if(n||(n={}),n.v=a[h][j],(b[k].format.indexOf("number")>-1||b[k].format.indexOf("bigNum")>-1)&&(n.t="n",n.z="#,###",n.v&&null!=n.v&&""!=n.v||(n.v=0),0==n.v&&delete n.z),b[k].format.indexOf("percent")>-1){n.t="n";var o=parseFloat(n.v);isNaN(o)?n.v="":(o=(o/100).toFixed(4),n.v=o)}if(""==b[k].format&&(n.t="s"),f[m]=n,"symbol2"==j&&b[j+i]){var m=b[j+i].cell+(g+parseInt(h)),n=f[m];n.v=a[h][j]}}}}}d(c)})})["catch"](function(a){return a})},generateWorksheetFile:function(a,b){function c(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d!=a.length;++d)c[d]=255&a.charCodeAt(d);return b}var d={bookType:"xlsx",bookSST:!1,type:"binary",cellStyles:!0},e=XLSX.write(a,d),f=new Date,g="SuperStock"+f.getFullYear()+(f.getUTCMonth()+1)+f.getUTCDate()+".xlsx";saveAs(new Blob([c(e)],{type:""}),g),b&&b()}}}]),angular.module("superstockApp").factory("common",["utils","$sce",function(a,b){return{syncMarketSummary:function(b){a.getMarketSummary().then(function(a){b.headerTitle=a})["catch"](function(a){console.error("Exception when getMarketSummary")})},syncTradingDate:function(b){a.getTradingDate().then(function(a){b.tradingDate=a})["catch"](function(a){console.error("Exception when getTradingDate")})},clickSymbolPopupDetails:function(c){$(document).ready(function(){$(document).on("click",".chart-icon",function(){$("#myModal").modal("show"),c.stockInfo=$(this).data("symbol"),c.iSrc="https://dchart.vndirect.com.vn/?symbol="+$(this).data("symbol"),c.iSrcTrust=b.trustAsResourceUrl(c.iSrc)}),$(document).on("click",".information-icon",function(){$("#companyModal").modal("show");var b=$(this).data("symbol");$(this).data("industry");c.companyInfo=b,a.getCompanyInformation(b).then(function(a){c.companyDatas=a})["catch"](function(a){console.error("Could not load company info",a)})})})}}}]),angular.module("superstockApp").factory("$tableRepository",["$http","$q","$rootScope","auth","$firebaseObject","Ref",function(a,b,c,d,e,f){return{loadFullColSettings:function(){var a=b.defer(),c=e(f.child("superstock_titles")),d=e(f.child("superstock_headers")),g=e(f.child("superstock_format"));return b.all([c.$loaded(),d.$loaded(),g.$loaded()]).then(function(){var b=c.data.split("|"),e=d.data.split("|"),f=g.data.split("|"),h={"Mã":90,industry:220,close:85,change:85,acc_vol_change:85,value:140,short_signal:120,eps:85,eps_grow:90,eps_grow_prev:135,revenue_grow:145,profit_grow:135,power:75,new_point:75,basic:75,capital_grow_3yr:110,volume:125,ma_v15:120,ma_c30:120,capital:100,pe:80,bv:120,roe:90,dividend:125,debt_capital_ratio:125,fx_effect:125,net_cash_flow:155,cut_loss:100,buy_date:150,buy_price:100,pnl:100,institution_holdings:90,hl_percent_T5:110,hl_percent_T20:110,max_close_30:130,c4:120,c1:120,trend:110,canslim:100,sideway:95,peak_T30:130,recover_buy:125,symbol:80,disrupt_buy:125},i=[];for(var j in b){var k={field:e[j],format:f[j],title:b[j]},l=k.format.split(":")[0];k.type=l,k.isNumber="bigNum"===l||"number"===l||"percent"===l,k.width=h[k.field],i.push(k)}a.resolve(i)}),a.promise},loadColSettings:function(a,c){var d=b.defer(),g=e(f.child("summary_titles")),h=e(f.child("summary_headers")),i=e(f.child("summary_format")),j=e(f.child("users/"+a+"/tableSettings/"+c));return b.all([g.$loaded(),h.$loaded(),i.$loaded(),j.$loaded()]).then(function(){if(!g.data||!h.data||!i.data)throw new Error("One or all format data could not be loaded from server, check your firebase realtime database");var a=g.data.split("|"),b=h.data.split("|"),c=i.data.split("|"),e=100,f={symbol:{width:120},matchPrice:{width:100},priceChange:{width:100},totalValue:{width:120},volumeChange:{width:100},EPS:{width:75},newPoint:{width:75},power:{width:75},Canslim:{width:100},pricePeak:{width:100},signal1:{width:120},symbol2:{width:75},signal2:{width:130}};for(var k in a){var l=j[b[k]]||{},m=f[b[k]]||{width:e};j[b[k]]=Object.assign(l,m,{field:b[k],title:a[k],format:c[k]})}var n=[];for(var k in a){var o=b[k],p=j[o],q=p.format.split(":")[0];n[k]=Object.assign({isNumber:"bigNum"===q||"number"===q||"percent"===q,type:q},p)}d.resolve(n)}),d.promise},saveColSetting:function(a,b,c,d){var g=e(f.child("users/"+a+"/tableSettings/"+b+"/"+c));g=Object.assign(g,d),g.$save()}}}]),angular.module("superstockApp").factory("$portfolioRepository",["$http","$q","$rootScope","auth","$firebaseObject","Ref",function(a,b,c,d,e,f){function g(a){function b(b){if("number"==typeof a[d]){if(!isNaN(a[d]))return!0}else if(void 0!==a[d])return!0;return!1}var c={};for(var d in a)b(a[d])&&(c[d]=a[d]);return c}var h="portfolio";return{setName:function(a){h=a},saveEntry:function(a,b){if(b.id){var c=e(f.child("users/"+a+"/"+h+"/data/"+b.id));c.$value=g(b),c.$save().then(function(){console.debug("$portfolioRepository: Save portfolio entry success",{uid:a,$entry:c})},function(b){console.error("$portfolioRepository: Save entry failed uid with error",a,b)})}},deleteEntry:function(a,c){if(c&&a){var d=b.defer(),g=e(f.child("users/"+a+"/"+h+"/data/"+c));return g.$remove().then(function(){console.debug("$portfolioRepository: Delete entry success",{uid:a,$entry:g}),d.resolve()},function(b){console.error("$portfolioRepository: Delete entry failed",{uid:a,error:b}),d.reject()}),d.promise}},loadAll:function(a){var c=b.defer(),d=e(f.child("users/"+a+"/"+h));return d.$loaded().then(function(a){if(console.log("Data loaded",d),a=a.data,!a)return void c.resolve([]);var b=Object.keys(a).map(function(b){return a[b]});c.resolve(b)})["catch"](function(a){c.reject(a)}),c.promise}}}]),angular.module("superstockApp").factory("sellDataProvider",["$firebaseObject","Ref","$q",function(a,b,c){var d={};return{subscribe:function(c,e){d[e]&&d[e].unwatch();var f=a(b.child("sell_signals/"+e)),g=f.$watch(function(a){var b=f.data;b&&(b.symbol=a.key,c.changed&&c.changed(a.key,b))});d[e]={unwatch:g}},unsubscribe:function(a){d[a]&&d[a].unwatch(),delete d[a]},colSettings:function(){return[{field:"symbol",format:"",isNumber:!1,title:"Mã",type:"",width:80,editable:!0},{field:"quantity",format:"number:3:3:280",isNumber:!0,title:"KL",type:"number",width:70,editable:!0},{field:"costPrice",format:"number:3:3:280",isNumber:!0,title:"Giá \nvốn",type:"number",width:70,editable:!0},{field:"close",format:"number:3:3:280",isNumber:!0,title:"Giá \nthị trường",type:"number",width:100},{field:"totalCost",format:"number:3:3:280",isNumber:!0,title:"Tổng \ngiá vốn",type:"bigNum",width:90},{field:"totalValue",format:"number:3:3:280",isNumber:!0,title:"Tổng \nthị giá",type:"bigNum",width:90},{field:"pnlValue",format:"number:3:3:280",isNumber:!0,title:"Lãi/Lỗ",type:"bigNum",width:100},{field:"pnl",format:"percent:3:3:280",isNumber:!0,title:"% \nLãi/Lỗ",type:"percent",width:90},{field:"weight",format:"percent:3:3:280",isNumber:!0,title:"% \nPhân bổ",type:"percent",width:90},{field:"cutLoss",format:"number:3:3:280",isNumber:!0,title:"Bán \ncắt lỗ",type:"number",width:90},{field:"take_profit",format:"number:3:3:280",isNumber:!0,title:"Bán \nchặn lãi",type:"number",width:80},{field:"two_down",format:"number:3:3:280",isNumber:!0,title:"Giảm \n2 nến đỏ",type:"number",width:80},{field:"min_T10",format:"number:3:3:280",isNumber:!0,title:"Thấp nhất\n4 phiên",type:"number",width:90},{field:"delete",width:20}]}}}]),angular.module("superstockApp").factory("$table",["$tableRepository","$gridSettings","utils","$window",function(a,b,c,d){return{ready:function(a){$scope.gridMainOptions.api.onGridReady(function(){console.log("Grid Ready"),a()})},create:function(e,f,g,h,i){f.gridMainOptions={enableSorting:!0,enableFilter:!0,suppressColumnVirtualisation:!0,suppressContextMenu:!0,rowData:[],data:[],enableColResize:!0,headerHeight:50,overlayLoadingTemplate:'<span class="ag-overlay-loading-center">Đang xử lý dữ liệu...</span>',sortingOrder:["desc","asc"],angularCompileRows:!0,onGridReady:function(a){i&&"onGridReady"in i&&i.onGridReady(a)},onColumnPinned:function(b){console.log("onColumnPinned",b);var c=b.column,d=c.colDef.field,e=b.pinned;a.saveColSetting(h,g.name,d,{pinned:e})},onSortChanged:function(a,b){console.log("Sort Changed",a,f.gridMainOptions.api.getSortModel());var c=f.gridMainOptions.api.getSortModel();if(c)for(var e in c){var h=c[e].colId,i=c[e].sort,j=f.gridMainOptions.columnApi.getColumn(h);d.ga("send",{hitType:"event",eventCategory:"table:"+g.name,eventAction:"sort",eventLabel:"sort "+i+" "+j.colDef.field})}},onCellValueChanged:function(a){"onCellValueChanged"in i&&i.onCellValueChanged(a)}};var j={};return{getData:function(){return j},getRowHasSymbol:function(a){return Object.values(j).filter(function(b){return b.symbol==a})},getLastRecord:function(){console.log("table getLastRecord()",this);var a=Object.keys(j);return j[a[a.length-1]]},newRow:function(){return this.added(Date.now(),{})},refresh:function(){var a=Object.keys(j).map(function(a){return j[a]});f.gridMainOptions.api.setRowData(a)},setColSettings:function(a){var d=a.map(function(a){var d={field:a.field,width:a.width,headerName:a.title||"",enableTooltip:!0,tooltipField:a.field,headerCellTemplate:b.headerCellTemplate,sort:a.field==g.defaultSort?g.direction:void 0,cellFilter:a.isNumber?"number":"string",pinned:"symbol"==a.field?"left":a.pinned,suppressSorting:"sellSignal"==a.field,editable:a.editable};return a.editable||(d.cellRenderer=function(c){return b.cellRenderer(a,c)}),"delete"==a.field&&(d.cellRenderer=function(a){return'<div style="cursor:pointer" ng-click="deleteRecord(data,'+a.node.id+')">X</div>'}),d.cellClass=function(b){var d="";return b.data.symbol==e.mainSelected&&(d=e.mainSelected),c.getCellClassSummary(b,a,d)},d});e.filters=d,f.gridMainOptions.api&&f.gridMainOptions.api.setColumnDefs(d)},getHeaderConfig:function(a){return{idLabel:"Mã",labelList:a.map(function(a){return{fieldName:a.field,format:a.format}})}},loaded:function(a){j={};for(var b in a){var c=a[b].id||a[b].symbol;j[c]=a[b]}console.debug("table.js - loaded",a,j),f.gridMainOptions.api.setRowData(a)},loading:function(){f.gridMainOptions.api.showLoadingOverlay()},added:function(a,b){b.id=a,j[a]=b,console.debug("table.js - added",a||"undefined",b,Object.keys(j),j),c.debounce(function(){var a=Object.keys(j).map(function(a){return j[a]});f.gridMainOptions.api.setRowData(a),console.debug("table.js - added debounce",a)},100)},changed:function(a,b){console.log("Record changed",a,b),j[a]=b,c.debounce(function(){var a=Object.keys(j).map(function(a){return j[a]});f.gridMainOptions.api.setRowData(a)},100)},removed:function(a){console.log("Record removed",a,j[a]),delete j[a],c.debounce(function(){var a=Object.keys(j).map(function(a){return j[a]});f.gridMainOptions.api.setRowData(a)},100)}}},createSellSymbolTable:function(a){var d="#"+a,e=document.querySelector(d);if(e){var f=b.getGridMarketOptions();new agGrid.Grid(e,f),console.log("new grid for sell symbols"),c.watchSellSymbols(function(a){console.log("Sell symbols updated",a);var b=a.map(function(a){return{sellSignal:a}});f.api&&f.api.setRowData(b);var c=$('div[ng-grid="gridMainOptions"]').find(".ag-body"),e=$(d).find(".ag-body-viewport");e.height(c.height()),e.css("background","#F4CCCC")})}}}}]),angular.module("superstockApp").factory("$gridSettings",["utils","$filter",function(a,b){return{getGridMarketOptions:function(){var b=[{headerName:"Báo bán",field:"sellSignal",width:70,headerCellTemplate:function(){return'<div class="ag-header-cell ag-header-cell-red ag-header-cell-sortable ag-header-cell-sorted-none"><table style="width:100%;height:100%"><tr><td><div id="agHeaderCellLabel" class="ag-header-cell-label"><span id="agText" class="ag-header-cell-text"></span></div></td></tr></table></div>'},cellClass:function(b){return a.getCellClassSummary(b,{sellSignal:""},"")}}];return{enableSorting:!1,enableFilter:!1,rowData:[],data:[],headerHeight:50,enableColResize:!1,suppressNoRowsOverlay:!0,columnDefs:b}},headerCellTemplate:function(a){function b(a){return"signal1"==a||"symbol2"==a||"signal2"==a?"ag-header-cell-green":"sellSignal"==a||"cutLoss"==a||"take_profit"==a||"two_down"==a||"min_T10"==a?"ag-header-cell-red":""}var c=a.column.colDef.field,d=b(c);return'<div class="ag-header-cell ag-header-cell-sortable ag-header-cell-sorted-none '+d+'"><table style="width:100%;height:100%"><tr><td width="6px" style="vertical-align:top"><span id="agMenu" class="ag-header-icon ag-header-cell-menu-button" style="opacity: 0; transition: opacity 0.2s, border 0.2s;"><svg width="6" height="12"><rect y="0" width="6" height="2" class="ag-header-icon"></rect><rect y="5" width="6" height="2" class="ag-header-icon"></rect><rect y="10" width="6" height="2" class="ag-header-icon"></rect></svg></span><div id="" class="ag-header-cell-label"><span id="agSortAsc" class="ag-header-icon ag-sort-ascending-icon ag-hidden"><svg width="6" height="10"><polygon points="0,6 3,0 6,6"></polygon></svg></span>    <span id="agSortDesc" class="ag-header-icon ag-sort-descending-icon ag-hidden"><svg width="6" height="10"><polygon points="0,0 3,6 6,0"></polygon></svg></span><span id="agNoSort" class="ag-header-icon ag-sort-none-icon ag-hidden"><svg width="10" height="10"><polygon points="0,4 5,0 10,4"></polygon><polygon points="0,6 5,10 10,6"></polygon></svg></span><span id="agFilter" class="ag-header-icon ag-filter-icon ag-hidden"><svg width="10" height="10"><polygon points="0,0 4,4 4,10 6,10 6,4 10,0" class="ag-header-icon"></polygon></svg></span></div></td><td><div id="agHeaderCellLabel" class="ag-header-cell-label"><span id="agText" class="ag-header-cell-text"></span></div></td></tr></table></div>'},cellRenderer:function(a,c){var d=c.colDef.field;if("symbol"==d&&console.debug("Render cell",d,c.data),a.editable)return null;switch(d){case"symbol2":return""==c.data.signal1&&""==c.data.signal2?'<div data-symbol="'+c.data.symbol+'" title=""></div>':'<div class="chart-icon" data-symbol="'+c.data.symbol+'" title="'+c.value+'">'+c.value+"</div>";case"newPoint":case"EPS":case"fxEffect":case"cashFlow":var e="";return e=isNaN(parseFloat(c.value))?b("number")(0,0):b("number")(parseFloat(c.value),0),'<div data-symbol="'+c.data.symbol+'" title="'+e+'">'+e+"</div>";case"symbol":var f=c.value;return"<div><span>"+c.value+'</span><img class="chart-icon" data-symbol="'+f+'" data-industry = "'+c.node.data.industry+'" src="./images/icon-graph.png"><img class="information-icon" data-symbol="'+f+'" data-industry = "'+c.node.data.industry+'" src="./images/icon-information.png" /></div>';case"signal2":var e=c.value,g="";return""!==e&&(e=c.data.symbol,g='<img class="chart-icon" data-symbol="'+c.data.symbol+'" data-industry = "'+c.node.data.industry+'" src="./images/icon-graph.png">'),'<div data-symbol="'+c.data.symbol+'" title="'+e+'">'+e+g+"</div>";default:var e="";return a.isNumber&&"Bản thu phí"!==c.value?(e=b("number")(c.value),"percent"===a.type?isNaN(parseFloat(c.value))?e="":(e=b("number")(c.value,2),e+="%"):"number"===a.type?e=b("number")(c.value,2):"bigNum"===a.type&&(e=b("number")(c.value,0)),e=e||"-",'<div data-symbol="'+c.data.symbol+'" title="'+e+'">'+e+"</div>"):'<div data-symbol="'+c.data.symbol+'" title="'+c.value+'">'+c.value+"</div>"}}}}]),angular.module("superstockApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),angular.module("firebase.auth",[]).constant("SIMPLE_LOGIN_PROVIDERS",["password","facebook"]).constant("loginRedirectPath","/login").factory("auth",["$firebaseAuth",function(a){return a()}]),angular.module("firebase.ref",["firebase"]).factory("Ref",function(){return firebase.database().ref()}),angular.module("superstockApp").controller("LoginCtrl",["$scope","auth","$location",function(a,b,c){function d(a){var b=(rootRef.child("users").child(a.uid),$q.defer());return ref.set({email:email,name:e(email)},function(a){$timeout(function(){a?b.reject(a):b.resolve(ref)})}),b.promise}function e(a){return f(a.substr(0,a.indexOf("@"))||"")}function f(a){a+="";var b=a.charAt(0).toUpperCase();return b+a.substr(1)}function g(){c.path("/account")}function h(b){a.err=b}a.loginBtn=!0,a.logoutBtn=!0,b.$onAuthStateChanged(function(b){b&&(console.log(" logged: "+b.uid),a.logoutBtn=!0,a.loginBtn=!1,c.path("/account"))}),a.oauthLogin=function(a){b.$signInWithPopup(a).then(function(a){console.log("logged"),g()})["catch"](function(a){console.log("login error"),h(a)})},a.anonymousLogin=function(){b.$signInAnonymously().then(function(a){console.log("logged ",a.uid)})["catch"](function(a){console.log("login error ",a)})},a.passwordLogin=function(a,c){b.$signInWithEmailAndPassword(a,c).then(function(a){g(),console.log("logged")})["catch"](function(a){h(a),console.log("error: "+a)})},a.createAccount=function(c,e,f){a.err=null,e?e!==f?a.err="Passwords do not match":b.$createUserWithEmailAndPassword(c,e).then(function(a){return console.log("User "+a.uid+" created successfully"),a}).then(function(a){console.log("Logged user: ",a.uid),d(),g()})["catch"](function(a){console.error("Error: ",a)}):a.err="Please enter a password"}}]),angular.module("superstockApp").controller("AccountCtrl",["$scope","auth","currentAuth",function(a,b,c,d){function e(a){console.log("Error: ",a)}a.user={uid:c.uid,name:c.displayName,photo:c.photoURL,email:c.email},a.authInfo=c,a.changePassword=function(c,d,f){a.err=null,c&&d?d!==f?e("Passwords do not match"):b.$updatePassword(d).then(function(){console.log("Password changed")},e):e("Please enter all fields")},a.changeEmail=function(a){b.$updateEmail(a).then(function(){console.log("email changed successfully")})["catch"](function(a){console.log("Error: ",a)})},a.logout=function(){b.$signOut()},a.updateProfile=function(a,b){firebase.auth().currentUser.updateProfile({displayName:a,photoURL:b}).then(function(){console.log("updated")})["catch"](function(a){console.log("error ",a)})}}]),angular.module("superstockApp").controller("MainCtrl",["$rootScope","$scope","auth","Ref","dataProvider","$window","tableSettings","$tableRepository","$table","common",function(a,b,c,d,e,f,g,h,i,j){a.link=g.name,f.ga("send","pageview","Tổng hợp");var k=c.$getAuth().uid;j.syncMarketSummary(b),j.syncTradingDate(b),j.clickSymbolPopupDetails(b);const l=i.create(a,b,g,k);i.createSellSymbolTable("grid-market-options"),h.loadColSettings(k,g.name).then(function(b){l.setColSettings(b),console.log("ColSettings",b),e.load(a.user.account.active,d.child(g.gridDataSource),l.getHeaderConfig(b),function(){l.loading()},function(a){console.debug("main.js - table data loaded",a),l.loaded(a)},{added:function(a,b,c){console.debug("main.js - table data added",b.key,a),l.added(b.key,a)},changed:function(a,b,c){console.debug("main.js - table data changed",b.key,a),l.changed(b.key,a)},removed:function(a){console.debug("main.js - table data removed",childSnapshot.key,data),l.removed(a.key)}})})}]),angular.module("superstockApp").controller("PersonalCtrl",["$rootScope","$scope","auth","currentAuth","Ref","sellDataProvider","$window","tableSettings","$tableRepository","$table","common","utils","$portfolioRepository",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){a.cutLoss=.96*a.costPrice,a.take_profit=a.raw_take_profit>a.costPrice?a.raw_take_profit:null,a.two_down=a.close>a.costPrice?a.raw_two_down:null,a.min_T10=a.close>a.costPrice?a.raw_min_T10:null,a.pnl=(a.close-a.costPrice)/a.costPrice*100,a.pnlValue=(a.close-a.costPrice)*a.quantity*1e3,a.totalCost=a.costPrice*a.quantity*1e3,a.totalValue=+a.quantity*+a.close*1e3}function o(a){var b=Object.keys(a).map(function(b){return a[b].quantity*a[b].close||0}).reduce(function(a,b){return a+b});for(var c in a){var d=a[c].quantity*a[c].close;a[c].weight=d/b*100}}function p(a,b){console.debug("recomputeAndRefereshTable()",a,b),n(a),o(b.getData()),l.debounce(function(){b.refresh()},200)}function q(a){var b=a.getLastRecord();b.symbol&&a.newRow()}function r(a,b){f.subscribe({changed:function(c,d){var e=b.getRowHasSymbol(a.symbol);for(var f in e)e[f].close=+d.close,e[f].raw_take_profit=+d.take_profit,e[f].raw_two_down=+d.two_down,e[f].raw_min_T10=+d.min_T10,p(e[f],b)}},a.symbol)}a.link=h.name,g.ga("send","pageview","recomendation");var s=c.$getAuth().uid;k.syncMarketSummary(b),k.syncTradingDate(b),k.clickSymbolPopupDetails(b);const t=j.create(a,b,h,s,{onGridReady:function(){var a=f.colSettings();t.setColSettings(a),m.loadAll(d.uid).then(function(a){if(console.log("RecommendationCtrl: User portoflio loaded",a),0===a.length)t.newRow();else{t.loaded(a),q(t);for(var b in a)r(a[b],t)}})},onCellValueChanged:function(a){console.log("onCellValueChanged",a);var b=a.data;if("symbol"==a.colDef.field){var c=a.newValue.toUpperCase();b.symbol=c;var e=a.oldValue;f.unsubscribe(e),r(b,t)}m.saveEntry(d.uid,{id:b.id,symbol:b.symbol,quantity:b.quantity,costPrice:b.costPrice}),("costPrice"==a.colDef.field||"quantity"==a.colDef.field)&&p(a.data,t),q(t)}});b.deleteRecord=function(a,b){console.debug("deleteRecord",a,b),m.deleteEntry(d.uid,a.id).then(function(){t.removed(a.id)})}}]),angular.module("superstockApp").controller("DiaryCtrl",["$rootScope","$scope","auth","currentAuth","Ref","sellDataProvider","$window","tableSettings","$tableRepository","$table","common","utils","$portfolioRepository",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,b){f.subscribe({changed:function(c,d){var e=b.getRowHasSymbol(a.symbol);for(var f in e)e[f].close=+d.close,p(e[f],b)}},a.symbol)}function o(a){var b=a.sellPrice?a.sellPrice:a.close;a.pnlPercent=(b-a.buyPrice)/a.buyPrice*100,a.pnl=(b-a.buyPrice)*a.quantity*1e3,a.cutLoss=a.buyPrice?.96*a.buyPrice:""}function p(a,b){console.debug("recomputeAndRefereshTable()",a,b),o(a),l.debounce(function(){b.refresh()},200)}function q(a){var b=a.getLastRecord();b.symbol&&a.newRow()}a.link=h.name,g.ga("send","pageview","recomendation");var r=c.$getAuth().uid;k.syncMarketSummary(b),k.syncTradingDate(b),k.clickSymbolPopupDetails(b),m.setName("diary");var s=[{field:"symbol",format:"",isNumber:!1,title:"Mã",type:"",width:80,editable:!0},{field:"close",format:"number:3:3:280",isNumber:!0,title:"Giá \nhiện tại",type:"number",width:70,editable:!0},{field:"cutLoss",format:"number:3:3:280",isNumber:!0,title:"Giá \ncắt lỗ",type:"number",width:70,editable:!0},{field:"quantity",format:"number:3:3:280",isNumber:!0,title:"KL",type:"number",width:70,editable:!0},{field:"buyPrice",format:"number:3:3:280",isNumber:!0,title:"Giá \nmua",type:"number",width:70,editable:!0},{field:"sellPrice",format:"number:3:3:280",isNumber:!0,title:"Giá \nbán",type:"number",width:70,editable:!0},{field:"pnlPercent",format:"number:3:3:280",isNumber:!0,title:"Lãi lỗ %",type:"number",width:90},{field:"pnl",format:"number:3:3:280",isNumber:!0,title:"Lãi lỗ tiền",type:"bigNum",width:90},{field:"buyDate",format:"number:3:3:280",isNumber:!0,title:"Ngày mua",type:"",width:90,editable:!0},{field:"sellDate",format:"number:3:3:280",isNumber:!0,title:"Ngày bán",type:"",width:90,editable:!0},{field:"note",format:"text",isNumber:!1,title:"Ghi chú",type:"",width:500,editable:!0},{field:"delete",width:20}];const t=j.create(a,b,h,r,{onGridReady:function(){var a=s;t.setColSettings(a),m.loadAll(d.uid).then(function(a){if(console.log("RecommendationCtrl: User portoflio loaded",a),0===a.length)t.newRow();else{t.loaded(a),q(t);for(var b in a)n(a[b],t)}})},onCellValueChanged:function(a){console.log("onCellValueChanged",a);var b=a.data;if("symbol"==a.colDef.field){var c=a.newValue.toUpperCase();b.symbol=c;var e=a.oldValue;f.unsubscribe(e),n(b,t)}m.saveEntry(d.uid,{id:b.id,symbol:b.symbol,quantity:b.quantity,buyPrice:b.buyPrice,sellPrice:b.sellPrice,buyDate:b.buyDate,sellDate:b.sellDate,note:b.note}),("buyPrice"==a.colDef.field||"sellPrice"==a.colDef.field||"quantity"==a.colDef.field)&&p(a.data,t),q(t)}});b.deleteRecord=function(a,b){console.debug("deleteRecord",a,b),m.deleteEntry(d.uid,a.id).then(function(){t.removed(a.id)})}}]),angular.module("superstockApp").controller("FullStockCtrl",["$rootScope","$scope","auth","$firebaseArray","$firebaseObject","Ref","dataProvider","uiGridConstants","$sce","utils","currentAuth","$window","$compile","$filter","$timeout","link","$gridSettings","$tableRepository",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){function s(b,c){a.filterOn&&(void 0!=b&&(C=b),y?u():a.filterData&&null!=a.filterData?t(a.filterData):a.resetFilter())}function t(a){a&&(a=a[0]),C||(b.gridOptions.api&&null!=b.gridOptions.api&&b.gridOptions.api.showLoadingOverlay(),C=!0),o(function(){var c={};for(var d in a)a[d].condition&&a[d].term&&(c[d]={type:a[d].condition,filter:a[d].term});b.gridOptions.api&&(b.gridOptions.api.setFilterModel(c),b.gridOptions.api.onFilterChanged())},500)}function u(c,d){x++,x<=Object.keys(a.filterList).length||(C||(b.gridOptions.api&&null!=b.gridOptions.api&&b.gridOptions.api.showLoadingOverlay(),C=!0),o(function(){if(b.gridOptions.api&&null!=b.gridOptions.api){b.gridOptions.api.setFilterModel(null);for(var c in a.filterList){var d=a.filterList[c],e=b.gridOptions.api.getFilterApi(c);if(d.filter){var f=d.filter.term;if(f&&f.length>0){var g=[];for(var h in f)g.push(f[h].value);g.length>0?e.setModel(g):e.selectEverything&&e.selectEverything()}else e.selectEverything&&e.selectEverything()}else if(d.filters&&d.filters[0]){
var i=b.gridOptions.api.getFilterApi(c);if((i.GREATER_THAN||d.filters[0].condition)&&(d.filters[0].term||0==d.filters[0].term)){var j=i.GREATER_THAN?i.GREATER_THAN:d.filters[0].condition;i.setType(j),i.setFilter(d.filters[0].term)}}}b.gridOptions.api.onFilterChanged()}},600),a.saveFilterSetting())}function v(){$(".ui-grid-header-cell").each(function(){var a=$(this),b=a.find("span");b.text().indexOf("\n")<0?(b.parent().css("line-height","40px"),a.css("text-align","center")):b.last().css("margin-top","-2px")})}a.link=p,l.ga("send","pageview","Đầy đủ");var w=null,x=0,y=!1;a.filterList={};var z="/personalPortfolio",A=e(f.child("users/"+k.uid+z));if(A.$loaded(function(a){b.personalStocks=a.$value}),a.filterPersonalStocks=function(){var a,c=[];if(b.personalStocks||(b.personalStocks="MWG,PNJ,FPT"),b.fullData){a=b.personalStocks.split(","),a=a.map(function(a){return a.toUpperCase().trim()});for(var d=0;d<b.fullData.length;d++){var e=b.fullData[d];-1!==a.indexOf(e.symbol)&&c.push(e)}b.gridOptions.api&&null!=b.gridOptions.api&&b.gridOptions.api.setRowData(c),A.$value=b.personalStocks,A.$save()}else console.error("Data is not loaded fully yet, please try again")},k){var B=e(f.child("users/"+k.uid+"/filter"));a.filterRef=B,B.$loaded(function(a){if(w={},a.individualFilter)for(var b in a.individualFilter)"$"!=b.charAt(0)&&"forEach"!=b&&(w[b]=a[b])});var A=e(f.child("users/"+k.uid+z));A.$loaded(function(a){console.log("User portfolio loaded",a)},function(a){console.error("Error encounter while loading user portfolio",a)})}b.gridOptions={enableSorting:!0,enableFilter:!0,suppressColumnVirtualisation:!0,suppressContextMenu:!0,rowData:[],data:[],enableColResize:!0,headerHeight:50,overlayLoadingTemplate:'<span class="ag-overlay-loading-center">Đang xử lý dữ liệu...</span>',sortingOrder:["desc","asc"],onAfterFilterChanged:function(){},onCellClicked:function(a){}};var C=!1;a.filterModes=function(a){y=a,s(void 0)},a.parseBigNum=function(a){var b=parseFloat(a)/bigNum;return b},a.resetFilter=function(){b.gridOptions.api&&null!=b.gridOptions.api&&b.gridOptions.api.showLoadingOverlay(),o(function(){b.gridOptions.api&&(b.gridOptions.api.setFilterModel(null),b.gridOptions.api.onFilterChanged())},600)},a.search=function(a){var c=b.gridOptions.api.getFilterApi("symbol");c.setType(c.CONTAINS||"contains"),c.setFilter(a),b.gridOptions.api.onFilterChanged()},r.loadFullColSettings().then(function(c){function d(b){var c={};if(a.userSetting&&a.userSetting.sort&&a.userSetting.sort.full&&b==a.userSetting.sort.full.colId&&(c.sort=a.userSetting.sort.full.sort),a.userSetting&&a.userSetting.pinColumns&&a.userSetting.pinColumns.full){var d=a.userSetting.pinColumns.full.indexOf(b);d>-1&&(c.pinned="left")}if(a.userSetting&&a.userSetting.hiddenColumns&&a.userSetting.hiddenColumns.full){var d=a.userSetting.hiddenColumns.full.indexOf(b);d>-1&&(c.hide=!0)}return c}function e(c){j.debounce(function(){if(b.gridOptions.api&&null!=b.gridOptions.api){var d=Object.keys(c).map(function(a){return c[a]});"full"===a.link?b.gridOptions.api.setRowData(d):"personal-portfolio"===a.link&&(b.fullData=d,b.filterPersonalStocks())}s(!1)},100)}var h=[],i={idLabel:"Mã",labelList:[]},m={},o=c.map(function(a){return{field:a.field,width:a.width,headerName:a.title,cellClass:w,enableTooltip:!0,tooltipField:a.field,cellRenderer:function(b){return q.cellRenderer(a,b)},headerCellTemplate:q.headerCellTemplate}});for(var p in c){var r=c[p];m[r.field]=r.format,i.labelList.push({fieldName:r.field,format:r.format});var t=null,w=null,x="text";r.isNumber&&(x="number");var z=o[p];z=Object.assign(z,d(r.field)),t&&(z.cellFilter=t),x&&(z.filter=x);var A=1e9;if(""!=r.format){var B=r.format.split(":");if(4===B.length){var C=[{condition:"greaterThan",term:"bigNum"==B[0]?parseFloat(B[2])*A:parseFloat(B[2]),min:"bigNum"==B[0]?parseFloat(B[1])*A:parseFloat(B[1]),bigNum:"bigNum"==B[0]?!0:!1},{condition:"lessThan",term:1/0,max:"bigNum"==B[0]?parseFloat(B[3])*A:parseFloat(B[3])}];a.filterList[z.field]={headerName:z.headerName,filters:C}}}"Mã"==r.field&&(z.filter="text",z.pinned="left",z.cellRenderer=function(a){var b=a.value;return"<div><span>"+a.value+'</span><img class="chart-icon" data-symbol="'+b+'" data-industry = "'+a.node.data.industry+'" src="./images/icon-graph.png"><img class="information-icon" data-symbol="'+b+'" data-industry = "'+a.node.data.industry+'" src="./images/icon-information.png" /></div>'}),z.cellClass=function(b){var c="";return b.data.symbol==a.fullSelected&&(c=a.fullSelected),j.getCellClass(b,m,c)},h.push(z)}a.setFilterSetting(),a.userFilter&&(a.userFilter.individualFilter&&(a.filterList=filterConvert(a.filterList,a.userFilter.individualFilter)),y=a.userFilter.filterMode);var D={};return b.gridOptions.api&&(b.gridOptions.api.setColumnDefs(h),b.gridOptions.api.showLoadingOverlay(),g.load(a.user.account.active,f.child("superstock"),i,function(a){},function(c){if(b.gridOptions.api){b.gridOptions.api.hideOverlay(),b.gridOptions.api.addEventListener("afterSortChanged",function(c){var d=a.userSetting;d||(d={sort:{full:{}},pinColumns:{}}),d.sort=d.sort?d.sort:{full:{}},d.sort.full=d.sort.full?d.sort.full:{};var e=b.gridOptions.api.getSortModel();e&&e[0]&&(d.sort.full=e[0]);var g=f.child("users/"+k.uid);g.child("userSetting").set(d,function(a){a?console.log(a):console.log("Saved user setting",d)});var e=b.gridOptions.api.getSortModel();if(e)for(var h in e){var i=e[h].colId,j=e[h].sort,m=b.gridOptions.columnApi.getColumn(i),n=m.colDef.headerName;l.ga("send",{hitType:"event",eventCategory:"Đầy đủ - Sắp xếp dữ liệu",eventAction:"Sắp xếp",eventLabel:"Sắp xếp "+("desc"==j?"giảm dần":"tăng dần")+" theo "+n})}}),b.gridOptions.api.addEventListener("columnPinned",function(c){var d=a.userSetting;d||(d={sort:{full:{}},pinColumns:{full:{}}}),d.pinColumns||(d.pinColumns={full:[]}),d.pinColumns.full||(d.pinColumns.full=[]);var e=b.gridOptions.columnApi.getDisplayedLeftColumns();if(d.pinColumns.full=[],e)for(var g in e){var h=e[g].colId;d.pinColumns.full.push(h)}var i=f.child("users/"+k.uid);i.child("userSetting").set(d,function(a){a?console.log(a):console.log("Saved user setting")})}),b.gridOptions.api.addEventListener("beforeFilterChanged",function(a){}),b.gridOptions.api.addEventListener("afterFilterChanged",function(a){if(b.gridOptions.api.hideOverlay(),b.rowAfterFilter=b.gridOptions.api.rowModel.rowsToDisplay,y){var c=b.gridOptions.api.getFilterModel();for(var d in c){var e="",f=b.gridOptions.columnApi.getColumn(d);if(c[d]instanceof Array)e=f.colDef.headerName+" là "+c[d].join(" và ");else{var g=n("number")(c[d].filter);e=f.colDef.headerName+" có giá trị >= "+g}l.ga("send",{hitType:"event",eventCategory:"Bộ lọc",eventAction:"Bộ lọc cá nhân",eventLabel:e})}}}),b.gridOptions.api.addEventListener("columnVisible",function(c){var d=a.userSetting;d||(d={sort:{full:{}},pinColumns:{full:[]},hiddenColumns:{full:[]}}),d.hiddenColumns||(d.hiddenColumns={full:[]}),d.hiddenColumns.full||(d.hiddenColumns.full=[]);var e=b.gridOptions.columnApi.getAllColumns(),g=e.filter(function(a){return 0==a.visible}),h=[];if(g)for(var i in g)h.push(g[i].colId);d.hiddenColumns.full=h;var j=f.child("users/"+k.uid);j.child("userSetting").set(d,function(a){a?console.log(a):console.log("Saved user setting")})});for(var d in a.filterList)a.filterList[d].filters&&b.$watch('filterList["'+d+'"].filters[0].term',function(a,b){u(a,b)}),a.filterList[d].filter&&b.$watch('filterList["'+d+'"].filter.term',function(a,b){u(a,b)});setTimeout(function(){v()},1e3)}},{added:function(a,b,c){console.debug("Record added",b.key,a),D[b.key]=a,e(D)},changed:function(a,b,c){console.debug("Record changed",b.key,a),D[b.key]=a,e(D)},removed:function(a){console.log("Child removed",a)}})),c}).then(function(c){console.log("after loaded colSettings",c),b.rowAfterFilter=[],a.exportDatasheet=function(a){a.preventDefault(),$("#exportProccessing").modal("show"),o(function(){var a={};if(b.rowAfterFilter&&b.rowAfterFilter.length>0)for(var d in b.rowAfterFilter){var e=b.rowAfterFilter[d],f=e.data;a[e.childIndex]=f,a[e.childIndex]&&(a[e.childIndex].basicCustom="http://ivt.ssi.com.vn/CorporateProfile.aspx?Ticket="+a[e.childIndex].symbol,a[e.childIndex].chartCustom="https://banggia.vndirect.com.vn/chart/?symbol="+a[e.childIndex].symbol)}else{if(!b.gridOptions.api)return;b.gridOptions.api.forEachNode(function(b){var c=b.data;a[b.childIndex]=c,a[b.childIndex]&&(a[b.childIndex].basicCustom="http://ivt.ssi.com.vn/CorporateProfile.aspx?Ticket="+a[b.childIndex].symbol,a[b.childIndex].chartCustom="https://banggia.vndirect.com.vn/chart/?symbol="+a[b.childIndex].symbol)})}var g={},h=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","AA","AB","AC","AD","AE","AF","AG","AH","AI","AJ","AK","AL","AM","AN","AO","AP","AQ","AR","AS","AT","AU","AV","AW","AX","AY","AZ"];for(var d in c)g[c[d].field]={cell:h[d],format:c[d].format};j.writeData2Worksheet(a,g).then(function(a){j.generateWorksheetFile(a,function(){$("#exportProccessing").modal("hide")})})},500)}}),$(document).ready(function(){$(document).on("change",".subTerm",function(){$(this).each(function(){var c=$(this);c.prop("value",c.val());var d=c.data("model");b.$apply(function(){a.filterList[d].filters[0].term=parseFloat(c.val())*bigNum,c.prop("value",c.val())}),c.parent().next().children().slider({slide:function(a,b){c.prop("value",b.value/bigNum)}})})}),$(document).on("click",".chart-icon",function(){$("#myModal").modal("show"),b.stockInfo=$(this).data("symbol")+" - "+$(this).data("industry"),b.iSrc="https://dchart.vndirect.com.vn/?symbol="+$(this).data("symbol"),b.iSrcTrust=i.trustAsResourceUrl(b.iSrc)}),$(document).on("click",".information-icon",function(){$("#companyModal").modal("show");var a=$(this).data("symbol"),c=$(this).data("industry");b.companyInfo=a+" - "+c,j.getCompanyInformation(a).then(function(a){b.companyDatas=a})["catch"](function(a){})})})}]).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),angular.module("superstockApp").controller("MarketStatsCtrl",["$rootScope","$scope","auth","$firebaseArray","$firebaseObject","Ref","utils","currentAuth","link","$q",function(a,b,c,d,e,f,g,h,i,j){function k(a){return+a>0?"#1ee908":0==+a?"#fc0":0>+a?"#fb0000":void 0}function l(a){return Object.keys(a).map(function(b){return{name:a[b].id,value:a[b].value,change:a[b].change,percent:a[b].percent,color:k(a[b].change)}})}a.link=i;var m=e(f.child("stats/indices")),n=e(f.child("stats/commodities"));j.all([m.$loaded(),n.$loaded()]).then(function(){a.stats={commodities:{name:"Index hàng hoá",data:l(n.data)}}})["catch"](function(b){var c="Không lấy được thống kê thị trường, xin thử lại.";console.error(c,b),a.system={message:c,error:b},$("#sysModal").modal("show")})}]),angular.module("superstockApp").controller("MenuCtrl",["$rootScope","$scope","auth","$location","Ref","$firebaseObject","$timeout","$window",function(a,b,c,d,e,f,g,h){function i(){d.path("/")}function j(c,d){var g=c.toJSON();return new Promise(function(b,c){var d=f(e.child("users/"+g.uid));a.$userRef=d,d.$loaded(function(a){a?(g.account=a.account,b(g)):b()})}).then(function(f){return f||(f=c.toJSON()),new Promise(function(c,g){function h(){var a={fullName:f.displayName,email:f.email};return"password"==d&&(a.fullName=b.userSignup.fullName,a.phoneNumber=b.userSignup.phoneNumber),f.providerData&&f.providerData[0]&&(a.email=f.providerData[0].email),a}f.uid||(console.error("There is no uid, user created failed",f),g());var i=h(),j=e.child("users/");j.child(f.uid).update({"profile/fullName":i.fullName,"profile/email":i.email}).then(function(d){console.log("Saving user fullName and email success",d),a.fullName=b.userSignup.fullName,c(i)})["catch"](function(a){console.error("Error while setting userProfile",i,a),g()})})})}function k(a){var b=a;if("facebook"==a){b=new firebase.auth.FacebookAuthProvider;for(var c in b)b[c]instanceof Array&&b[c].push("email")}return b}function l(a){var c=b.form,d=b.userSignin;"signup"==a?(c=b.form_signup,d=b.userSignup):"changePassword"==a?(c=b.form_change_pasword,d=b.userProfile):"changeProfile"==a&&(c=b.form_change_profile,d=b.userProfile);var e=!0;return"changePassword"==a||"changeProfile"==a||(!d||d.email)&&c.email.$valid?b.checkEmail=!0:(b.checkEmail=!1,e=!1),c.password&&d&&(!d.password||d.password.length<7)?(b.checkPassword=!1,e=!1):b.checkPassword=!0,c&&c.confirm_password&&(d.password==d.confirmPassword&&d.confirmPassword?b.checkConfirmPassword=!0:(b.checkConfirmPassword=!1,e=!1)),c&&c.full_name&&(d&&!d.fullName?(b.checkFullName=!1,e=!1):b.checkFullName=!0),c&&c.new_password&&(!d.newPassword||d.newPassword.length<7?(b.checkNewPassword=!1,e=!1):b.checkNewPassword=!0),c&&c.confirm_new_password&&(d.newPassword==d.confirmNewPassword&&d.confirmNewPassword?b.checkConfirmNewPassword=!0:(b.checkConfirmNewPassword=!1,e=!1)),c&&c.phone_number&&(d.phoneNumber?b.checkPhoneNumber=!0:(b.checkPhoneNumber=!1,e=!1)),e}a.link="";b.filterShow=function(b){b.preventDefault(),b.stopPropagation(),"main"!=a.link&&($("#wrapper").toggleClass("toggled"),$("#wrapper").hasClass("toggled")?(a.filterOn=!0,$(".item-to-hide").removeClass("hidden")):(a.filterOn=!0,a.filterChangeGlobal(),a.setDataForDefaultFilter(),$("#js-navbar-collapse").find("ul > li").removeClass("active"),$("#filter-control").addClass("active"),$(".item-to-hide").addClass("hidden")))},b.userSignin={},b.userSignup={},b.userProfile={},b.checkEmail,b.checkPassword,b.checkSignIn=!0,b.checkConfirmPassword,b.checkFullName,b.checkNewPassword,b.checkConfirmNewPassword,b.disabledButton,b.loading=!1,b.oauthLogin=function(a){h.ga("send",{hitType:"event",eventCategory:"Đăng nhập tài khoản",eventAction:"Đăng nhập",eventLabel:""});var d=k(a);if("facebook"==a)c.$signInWithPopup(d).then(function(a){return j(a.user)}).then(function(a){$("#signInModal").modal("hide"),i()})["catch"](function(a){console.log("login error"),console.log(a)});else{if(!l())return void(b.checkSignIn=!0);b.disabledButton=!0,b.loading=!0,b.checkSignIn=!0,c.$signInWithEmailAndPassword(b.userSignin.email,b.userSignin.password).then(function(a){$("#signInModal").modal("hide"),b.disabledButton=!1,b.loading=!1,i()})["catch"](function(a){b.disabledButton=!1,b.loading=!1,a.code&&(b.checkSignIn=!1)})}},b.oauthSignUp=function(){b.checkSignUpMessage="",l("signup")&&(h.ga("send",{hitType:"event",eventCategory:"Đăng ký tài khoản",eventAction:"Đăng ký",eventLabel:""}),b.disabledButton=!0,b.loading=!0,c.$createUserWithEmailAndPassword(b.userSignup.email,b.userSignup.password).then(function(c){return a.userTmp={email:b.userSignup.email,displayName:b.userSignup.fullName,phoneNumber:b.userSignup.phoneNumber},j(c,"password")}).then(function(a){$("#signUpModal").modal("hide"),b.disabledButton=!1,b.loading=!1,i()})["catch"](function(a){b.disabledButton=!1,b.loading=!1,a.code&&(b.checkSignUp=!1,"auth/email-already-in-use"==a.code?b.checkSignUpMessage="Email đã được sử dụng bởi người dùng khác.":b.checkSignUpMessage=a.message)}))},b.logout=function(){c.$signOut(),a.$userRef&&a.$userRef.$destroy(),d.path("/")},a.openGuideModal=function(a){a.preventDefault(),$("#superStockGuideModal").modal("show")},a.activeDeactiveAccount=function(b,c){c.preventDefault();var d,g=new Promise(function(a,c){var g=f(e.child("users/"+b));d=g,g.$loaded(function(b){b&&b.account?a(b):c()})});g.then(function(c){return new Promise(function(d,f){var g=e.child("users/"+b),h={active:!0};if(c.account.active&&(h.active=!1),h.active){var i=new Date;i.setDate(i.getUTCDate()+1),h.expired_date=i.getFullYear()+"-"+(i.getUTCMonth()+1)+"-"+i.getUTCDate()}else h.expired_date="";g.child("account").set(h,function(b){b?f():(a.user.account.active=h.active,h.expired_date&&(a.user.account.expired_date=new Date(h.expired_date)),d())})})}).then(function(){$(c.target).parent().addClass("hidden"),d&&d.$destroy()})["catch"](function(a){$(c.target).parent().addClass("hidden"),d&&d.$destroy()})},b.signInForm=function(){b.checkEmail=!0,b.checkPassword=!0,b.checkSignIn=!0,b.checkConfirmPassword=!0,b.checkFullName=!0,b.loading=!1,b.userSignin={},$("#signInModal").modal("show")},b.signUpForm=function(){b.checkEmail=!0,b.checkPassword=!0,b.checkSignUp=!0,b.checkConfirmPassword=!0,b.checkFullName=!0,b.checkPhoneNumber=!0,b.loading=!1,b.userSignup={},$("#signUpModal").modal("show")},b.changePasswordForm=function(){b.checkEmail=!0,b.checkPassword=!0,b.checkSignIn=!0,b.checkConfirmPassword=!0,b.checkFullName=!0,b.checkPhoneNumber=!0,b.loading=!1,b.userSignup={},$("#changePasswordModal").modal("show")},b.changeProfileForm=function(){$("#changeProfileModal").modal("show")},b.checkChangePassword=!0,b.changePassword=function(){return l("changePassword")?(b.loading=!0,void c.$updatePassword(b.userProfile.newPassword).then(function(a){$("#changePasswordModal").modal("hide"),b.disabledButton=!1,b.loading=!1})["catch"](function(a){b.disabledButton=!1,b.loading=!1,a.code&&(b.checkChangePassword=!1)})):void(b.checkChangePassword=!0)},b.checkChangeProfile=!0,b.changeProfile=function(){if(!l("changeProfile"))return void(b.checkChangeProfile=!0);if(a.user){b.loading=!0,b.disabledButton=!0;var c=e.child("users/"+a.user.uid);c.update({"profile/fullName":b.userProfile.fullName,"profile/phoneNumber":b.userProfile.phoneNumber}).then(function(){b.$apply(function(){b.checkChangeProfile=!0,a.user.displayName=b.userProfile.fullName,a.user.phoneNumber=b.userProfile.phoneNumber}),$("#changeProfileModal").modal("hide"),b.disabledButton=!1,b.loading=!1})["catch"](function(a){console.error("Error while updating profile for user",b.userProfile,a),b.checkChangeProfile=!1,$("#changeProfileModal").modal("hide"),b.disabledButton=!1,b.loading=!1})}},$(document).on("hidden.bs.modal",".modal",function(){$(this);b.$apply(function(){b.checkEmail=!0,b.checkPassword=!0,b.checkSignIn=!0,b.checkConfirmPassword=!0,b.checkFullName=!0,b.checkNewPassword=!0,b.checkConfirmNewPassword=!0})}),$(document).on("hidden.bs.modal",".modal",function(){var a=$(this),c=a.find("input");$.each(c,function(a,b){$(b).attr("name")&&$(b).val("")}),b.$apply(function(){b.checkEmail=!0,b.checkPassword=!0,b.checkSignIn=!0,b.checkSignUp=!0,b.checkConfirmPassword=!0,b.checkFullName=!0,b.checkNewPassword=!0,b.checkConfirmNewPassword=!0,b.userSignin={},b.userSignup={},b.userProfile={}})}),$(document).on("shown.bs.modal","#changeProfileModal",function(){b.$apply(function(){a.user&&(b.userProfile.fullName=a.user.displayName,b.userProfile.phoneNumber=a.user.phoneNumber)})}),$(document).on("mouseenter",".ag-cell",function(){var a=$(this),b=a.parent(),c=b.find(".ag-cell");c.addClass("ag-cell-hover-bg")}),$(document).on("mouseleave",".ag-cell",function(){var a=$(this),b=a.parent(),c=b.find(".ag-cell");c.removeClass("ag-cell-hover-bg")}),a.mainSelected="",a.fullSelected="",$(document).on("click",".ag-cell",function(){var b=$(this),c=b.find("div").first().data("symbol");"main"==a.link?a.mainSelected=c:a.fullSelected=c;var d=$(".ag-row.clicked"),e=b.parent(),f=e.find(".ag-cell");d.find(".ag-cell").removeClass("ag-cell-focus-bg"),e.addClass("clicked"),f.addClass("ag-cell-focus-bg")})}]),angular.module("superstockApp").controller("FilterCtrl",["$rootScope","$scope","Ref","$firebaseArray","$compile","$window",function(a,b,c,d,e,f){b.defaultFilter=[{id:1,EPS:{term:1e3,condition:"greaterThan"},maVol30:{term:3e4,condition:"greaterThan"},point:{term:7,condition:"greaterThan"},profitChange:{term:20,condition:"greaterThan"},roe:{term:7,condition:"greaterThan"},filterName:"Cơ bản tốt"},{id:2,canslim:{term:"Canslim",condition:"contains"},maVol30:{term:3e4,condition:"greaterThanOrEqual"},filterName:"Canslim"},{id:3,totalValue:{term:5e9,condition:"greaterThanOrEqual"},priceChange:{term:1,condition:"greaterThanOrEqual"},EPS:{term:3e3,condition:"greaterThanOrEqual"},point:{term:7,condition:"greaterThanOrEqual"},filterName:"Siêu cổ phiếu"},{id:4,capital:{term:1e4,condition:"greaterThanOrEqual"},filterName:"Vốn hóa lớn"},{id:5,sideway:{term:"sideway",condition:"contains"},maVol30:{term:3e4,condition:"greaterThanOrEqual"},filterName:"Các mã sideway"},{id:6,totalValue:{term:3e9,condition:"greaterThanOrEqual"},pricePeak:{term:"Cao nhất 30 phiên",condition:"contains"},filterName:"Vượt đỉnh"},{id:7,totalValue:{term:2e9,condition:"greaterThanOrEqual"},disruptQtty:{term:30,condition:"greaterThanOrEqual"},maVol30:{term:2e4,condition:"greaterThanOrEqual"},filterName:"Đột biến KL"},{id:8,totalValue:{term:2e9,condition:"greaterThanOrEqual"},maVol30:{term:2e4,condition:"greaterThanOrEqual"},priceChange:{term:1,condition:"greaterThanOrEqual"},shorttermSignal:{term:"xMua nếu cơ bản tốt",condition:"contains"},filterName:"Điểm mua ngắn hạn"},{id:9,symbol:["AAA","VND"],filterName:"Danh mục cá nhân"}],b.individualFilter=!1,b.publicFilter=!0,b.filterModes,a.$watch("searchTerm",function(){a.search&&a.search(a.searchTerm)}),b.filterChange=function(){b.filter&&0==b.filter.length&&(b.filter=null),a.filterData=b.filter,a.filterModes&&a.filterModes(b.filterModes),a.saveFilterSetting(),!b.filterModes&&a.filterData&&a.filterData.length>0&&f.ga("send",{hitType:"event",eventCategory:"Bộ lọc",eventAction:"Bộ loc có sẵn",eventLabel:"Lọc theo "+a.filterData[0].filterName})},a.filterChangeGlobal=function(){b.filterChange()},b.$watch("filterModes",function(){a.filterModes&&(b.filterModes?(b.publicFilter=!1,b.individualFilter=!0,a.filterModes(!0)):(b.publicFilter=!0,b.individualFilter=!1,a.filterModes(!1)),a.saveFilterSetting())}),a.resetFilterModes=function(){b.filterModes=!1,b.publicFilter=!0,b.individualFilter=!1},$(document).on("click","#container-fluit-area, #footer-area, #header-area",function(c){$("#sidebar-wrapper").parent().hasClass("toggled")||($("#filter-control").removeClass("ng-hide"),$("#wrapper").toggleClass("toggled"),b.filter||b.filterModes||(a.filterOn=!1),a.filterOn||($("#js-navbar-collapse").find("ul > li").removeClass("active"),$("#full-stock").addClass("active")),$(".item-to-hide").removeClass("hidden"),b.$apply(function(){}))}),$(document).on("click","#full-stock",function(b){b.preventDefault(),"full"==a.link&&($("#js-navbar-collapse").find("ul > li").removeClass("active"),$(this).addClass("active"),a.resetFilterModes(),a.resetFilter()),a.filterOn=!1}),a.setDataForDefaultFilter=function(){},a.saveFilterSetting=function(){var d={};a.userFilter&&(d=a.userFilter,d.filterMode||d.publicFilter||d.individualFilter||(d={})),d.filterMode=b.filterModes;var e=[];if(b.filter&&null!=b.filter)for(var f in b.filter)e.push(b.filter[f].id);e&&(d.publicFilter=e);var g=filterConvert(a.filterList,null);g&&Object.keys(a.filterList).length>0&&(d.individualFilter=g);var h=c.child("users/"+a.user.uid);h.child("filter").set(d,function(a){a?console.log(a):console.log("Saved filter setting")})},a.setFilterSetting=function(){if(a.userFilter&&void 0!=a.userFilter.filterMode&&(b.filterModes=a.userFilter.filterMode,a.userFilter.publicFilter)){var c=[];for(var d in a.userFilter.publicFilter){var e=a.userFilter.publicFilter[d],f=b.defaultFilter.filter(function(a){return e==a.id});f&&f[0]&&c.push(f[0])}c&&c.length>0&&(b.filter=c)}}}]),angular.module("superstockApp").directive("ngShowAuth",["auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuthStateChanged(e),e()}}}]),angular.module("superstockApp").directive("ngHideAuth",["auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuthStateChanged(e),e()}}}]),angular.module("superstockApp").directive("categoryHeader",function(){function a(a){console.log(a.gridOptions.columnDefs),a.headerRowHeight=30,a.catHeaderRowHeight=a.headerRowHeight+"px",a.categories=[];var b="",c=0,d=0;cols=a.gridOptions.columnDefs;for(var e=0;e<cols.length;e++){c+=Number(cols[e].width);var f="undefined"==typeof cols[e].categoryDisplayName?" ":cols[e].categoryDisplayName;f!==b&&(a.categories.push({displayName:b,width:c-Number(cols[e].width),widthPx:c-Number(cols[e].width)+"px",left:d,leftPx:d+"px"}),d+=c-Number(cols[e].width),c=Number(cols[e].width),b=f)}c>0&&a.categories.push({displayName:b,width:c,widthPx:c+"px",left:d,leftPx:d+"px"})}return{templateUrl:"scripts/directives/templates/category_header.html",link:a}}),angular.module("superstockApp").config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],tableSettings:function(){return{gridDataSource:"summary_data",defaultSort:"volumeChange",direction:"desc",name:"main"}}}}).when("/investment",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],tableSettings:function(){return{gridDataSource:"investment_data",defaultSort:"volumeChange",direction:"desc",hideSymbol:!0,name:"investment"}}}}).when("/market_low",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],tableSettings:function(){return{gridDataSource:"market_low_data",defaultSort:"priceChange",direction:"desc",hideSymbol:!0,name:"market_low"}}}}).when("/long_term",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],tableSettings:function(){return{gridDataSource:"long_term_data",defaultSort:"priceChange",direction:"desc",hideSymbol:!0,name:"long_term"}}}}).when("/full",{templateUrl:"views/full-stock.html",controller:"FullStockCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],link:function(){return"full"}}}).when("/personal-portfolio",{templateUrl:"views/personal-portfolio.html",controller:"FullStockCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],link:function(){return"personal-portfolio"}}}).when("/personal",{templateUrl:"views/personal.html",controller:"PersonalCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],tableSettings:function(){return{gridDataSource:"summary_data",defaultSort:"priceChange",direction:"desc",hideSymbol:!0,name:"personal"}}}}).when("/diary",{templateUrl:"views/personal.html",controller:"DiaryCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],tableSettings:function(){return{gridDataSource:"summary_data",defaultSort:"priceChange",direction:"desc",hideSymbol:!0,name:"diary"}}}}).when("/market-stats",{templateUrl:"views/market-stats.html",controller:"MarketStatsCtrl",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}],link:function(){return"market-stats"}}}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/account",{templateUrl:"views/account.html",controller:"AccountCtrl",resolve:{currentAuth:["auth",function(a){return a.$requireSignIn()}]}}).when("/chat",{templateUrl:"views/chat.html",controller:"Chat",resolve:{currentAuth:["auth",function(a){return a.$waitForSignIn()}]}}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","loginRedirectPath","auth","$firebaseObject","Ref",function(a,b,c,d,e,f,g,h,i,j){a.globalActive=!1,d.$onAuthStateChanged(function(c){if(a.user=c?c.toJSON():void 0,a.userTmp&&a.user&&(a.user.displayName=a.userTmp.displayName,a.user.phoneNumber=a.userTmp.phoneNumber),a.user&&null!=a.user){var d=f.child("users/"+a.user.uid);a.$userRefChange=e(d),a.$userRefChange.$loaded(function(d){if(a.user){var e=!1;a.userSetting=d.userSetting,a.userFilter=d.filter,a.user.profile=d.profile,d.account?(a.user.account=d.account,c&&d&&d.profile&&(a.user.displayName=d.profile.fullName?d.profile.fullName:a.user.displayName,a.user.phoneNumber=d.profile.phoneNumber),a.fullName&&(a.user.displayName=a.fullName),a.user.account.expiredDate=new Date(d.account.expiredAt),a.user.account.shouldRenew=d.account.shouldRenew,a.user.account.daysTilExpiration=d.account.daysTilExpiration,1!=a.user.account.active&&(a.user.account.active=!1)):a.user.account={active:a.globalActive},e=a.user.account.active,e&&($("#expiredMessageModal").modal("show"),b.path("/"))}})}else a.$userRefChange&&a.$userRefChange.$destroy(),a.filterRef&&a.filterRef.$destroy(),a.$userRef&&a.$userRef.$destroy();a.showUI=!0}),a.$on("$routeChangeError",function(a,d,e,f){"AUTH_REQUIRED"===f&&b.path(c)})}]);